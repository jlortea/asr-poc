services:
  ##########################################
  # GATEWAY DEEPGRAM (deepgram-gw)
  ##########################################
  deepgram-gw:
    env_file:
      - ./.env
    image: node:20-alpine
    working_dir: /app
    command: ["sh","-c","cp /app/gw-package.json /app/package.json && npm install --omit=dev && node server/deepgram-gw.js"]
    environment:
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - WIDGET_PORT=${WIDGET_PORT}
      - RTP_PORT=${RTP_PORT}
      - DG_LANGUAGE=${DG_LANGUAGE}
      - DG_INTERIM=${DG_INTERIM}
      - DG_PUNCTUATE=${DG_PUNCTUATE}
      - DG_SMART_FORMAT=${DG_SMART_FORMAT}
      - DG_DIARIZE=${DG_DIARIZE}
      - SWAP_ENDIAN=${SWAP_ENDIAN}
      - DUMP_WAV=${DUMP_WAV}
    volumes:
      - ./server:/app/server
      - ./public:/app/public
      - ./gw-package.json:/app/gw-package.json:ro
    ports:
      - "18080:8080"        # widget (HTTP)
      - "40000:40000/udp"   # RTP/UDP publicado (gateway Deepgram)
    restart: unless-stopped

  ##########################################
  # GATEWAY MTI (mti-gw)  — RTP dinámico por llamada
  # Opción 2: puertos UDP dinámicos + /register
  # Recomendado: network_mode: host para escuchar el rango completo sin publicarlo.
  ##########################################
  mti-gw:
    env_file:
      - ./.env
    image: node:20-alpine
    working_dir: /app
    command: ["sh","-c","cp /app/gw-package.json /app/package.json && npm install --omit=dev && node server/mti-gw.js"]

    # MUY IMPORTANTE:
    # Con host network el contenedor escucha directamente en el host los UDP dinámicos,
    # por eso NO hay ports: para UDP.
    network_mode: host

    environment:
      - MTI_HOST=${MTI_HOST}
      - MTI_PORT=${MTI_PORT}

      # rango de puertos dinámicos (solo informativo aquí, el que lo usa es tap-service)
      - MTI_RTP_START=${MTI_RTP_START}
      - MTI_RTP_END=${MTI_RTP_END}

    volumes:
      - ./server:/app/server
      - ./gw-package.json:/app/gw-package.json:ro

    restart: unless-stopped

  ##########################################
  # TAP-SERVICE (ARI Snoop + ExternalMedia)
  ##########################################
  tap-service:
    env_file:
      - ./.env
    image: node:20-alpine
    working_dir: /app
    command: ["sh","-c","cp /app/tap-package.json /app/package.json && npm install --omit=dev && node server/tap-service.js"]
    environment:
      - ARI_URL=${ARI_URL}
      - ARI_USER=${ARI_USER}
      - ARI_PASS=${ARI_PASS}
      - TAP_APP_NAME=${TAP_APP_NAME}
      - TAP_HTTP_PORT=${TAP_HTTP_PORT}
      - RTP_HOST_MTI=${RTP_HOST_MTI}
      - RTP_HOST_DEEPGRAM=${RTP_HOST_DEEPGRAM}
      # opcional, solo por claridad
      - MTI_RTP_START=${MTI_RTP_START}
      - MTI_RTP_END=${MTI_RTP_END}
      - MTI_GW_HTTP_HOST=${MTI_GW_HTTP_HOST}
      - MTI_GW_HTTP_PORT=${MTI_GW_HTTP_PORT}
    volumes:
      - ./server:/app/server
      - ./tap-package.json:/app/tap-package.json:ro
    ports:
      - "3200:3200/tcp"   # /start_tap para el dialplan (CURL)
    restart: unless-stopped
