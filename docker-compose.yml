services:
  ##########################################
  # GATEWAY DEEPGRAM (deepgram-gw)
  ##########################################
  deepgram-gw:
    env_file:
      - ./.env
    image: node:20-alpine
    working_dir: /app
    command: ["sh","-c","cp /app/gw-package.json /app/package.json && npm install --omit=dev && node server/deepgram-gw.js"]
    environment:
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY}
      - WIDGET_PORT=${WIDGET_PORT}
 #    - RTP_PORT=${RTP_PORT}
      - DG_LANGUAGE=${DG_LANGUAGE}
      - DG_INTERIM=${DG_INTERIM}
      - DG_PUNCTUATE=${DG_PUNCTUATE}
      - DG_SMART_FORMAT=${DG_SMART_FORMAT}
      - DG_DIARIZE=${DG_DIARIZE}
      - SWAP_ENDIAN=${SWAP_ENDIAN}
      - DUMP_WAV=${DUMP_WAV}
    volumes:
      - ./server:/app/server
      - ./public:/app/public
      - ./gw-package.json:/app/gw-package.json:ro
    ports:
      - "18080:8080"        # widget (HTTP) + /metrics
      - "40000:40000/udp"   # RTP IN
      - "40001:40001/udp"   # RTP OUT
    restart: unless-stopped

  ##########################################
  # GATEWAY MTI (mti-gw)  — RTP dinámico por llamada
  ##########################################
  mti-gw:
    env_file:
      - ./.env
    image: node:20-alpine
    working_dir: /app
    command: ["sh","-c","cp /app/gw-package.json /app/package.json && npm install --omit=dev && node server/mti-gw.js"]
    network_mode: host
    environment:
      - MTI_HOST=${MTI_HOST}
      - MTI_PORT=${MTI_PORT}
      - MTI_RTP_START=${MTI_RTP_START}
      - MTI_RTP_END=${MTI_RTP_END}
    volumes:
      - ./server:/app/server
      - ./gw-package.json:/app/gw-package.json:ro
    ports:
      - "9093:9093"  # /metrics
    restart: unless-stopped

  ##########################################
  # TAP-SERVICE (ARI Snoop + ExternalMedia)
  ##########################################
  tap-service:
    env_file:
      - ./.env
    image: node:20-alpine
    working_dir: /app
    command: ["sh","-c","cp /app/tap-package.json /app/package.json && npm install --omit=dev && node server/tap-service.js"]
    environment:
      - ARI_URL=${ARI_URL}
      - ARI_USER=${ARI_USER}
      - ARI_PASS=${ARI_PASS}
      - TAP_APP_NAME=${TAP_APP_NAME}
      - TAP_HTTP_PORT=${TAP_HTTP_PORT}
      - RTP_HOST_MTI=${RTP_HOST_MTI}
    # - RTP_HOST_DEEPGRAM=${RTP_HOST_DEEPGRAM}
      - MTI_RTP_START=${MTI_RTP_START}
      - MTI_RTP_END=${MTI_RTP_END}
      - MTI_GW_HTTP_HOST=${MTI_GW_HTTP_HOST}
      - MTI_GW_HTTP_PORT=${MTI_GW_HTTP_PORT}
    volumes:
      - ./server:/app/server
      - ./tap-package.json:/app/tap-package.json:ro
    ports:
      - "3200:3200/tcp"   # /start_tap + /metrics
    restart: unless-stopped

  ##########################################
  # PROMETHEUS (persistente)
  ##########################################
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=15d
      - --storage.tsdb.retention.size=5GB


  ##########################################
  # GRAFANA (persistente)
  ##########################################
  grafana:
    image: grafana/grafana:10.4.1
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3000:3000"  # Dashboard UI
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus


volumes:
  prometheus_data:
  grafana_data:
